name: Move and Darken Block Textures

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  process-textures:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Create destination directory
        run: mkdir -p pack/textures/block

      - name: Move and darken textures
        run: |
          SRC_DIR="resource_pack/textures/blocks"
          DEST_DIR="Pack/textures/block"

          # ディレクトリ存在確認
          if [ ! -d "$SRC_DIR" ]; then
            echo "Source directory does not exist: $SRC_DIR"
            exit 1
          fi

          shopt -s nullglob
          for file in "$SRC_DIR"/*.png; do
            filename=$(basename "$file")

            # 除外リスト
            if [[ "$filename" =~ ^(fire_0|fire_1|soul_fire_0|soul_fire_1)\.png$ ]]; then
              echo "Skipping excluded file: $filename"
              continue
            fi

            # 既に存在する場合スキップ
            if [[ -e "$DEST_DIR/$filename" ]]; then
              echo "Skipping existing file: $filename"
              continue
            fi

            # 30%暗くしてコピー
            convert "$file" -evaluate Multiply 0.7 "$DEST_DIR/$filename"
            echo "Processed $filename"
          done

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Pack/textures/block
          git pull
          git commit -m "Move and darken block textures"
          git push
        continue-on-error: true
