name: Build Glyph Pack (sh + curl + ImageMagick)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y imagemagick curl

      - name: Setup Pack and font
        run: |
          mkdir -p Pack/font
          curl -L -o Pack/font/KosugiMaru-Regular.ttf https://github.com/google/fonts/raw/main/ofl/kosugimaru/KosugiMaru-Regular.ttf

      - name: Generate glyph PNGs
        run: |
          set -e
          IMG_SIZE=64
          RP_DIR=Pack
          FONT_FILE="$RP_DIR/font/KosugiMaru-Regular.ttf"
          mkdir -p "$RP_DIR/font/glyphs"

          # 使用したい文字列を一括定義
          CHARS=' !"#$%&'\''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~ÀÁÂÈÊËÍÓÔÕÚßãõğİıŒœŞşŴŵžȇ§©⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜø£Ø×ƒáíóúñÑªº¿®¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αβΓπΣσμτΦΘΩδ∞∅∈∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■'

          INDEX=0
          for CHAR in $(echo -n "$CHARS" | fold -w1); do
            HEX=$(printf "%02x" $INDEX)
            convert -size "${IMG_SIZE}x${IMG_SIZE}" -background none \
              -fill white -font "$FONT_FILE" -pointsize "$IMG_SIZE" \
              -gravity northwest caption:"$CHAR" \
              "$RP_DIR/font/glyph_$HEX.png"
            INDEX=$((INDEX + 1))
          done

      - name: Commit generated Pack
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Pack
          git diff-index --quiet HEAD || git commit -m "Auto-update glyph PNGs"
          git push
