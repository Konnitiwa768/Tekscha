name: Build Glyph Pack (sh + curl + ImageMagick)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y imagemagick curl

      - name: Setup Pack and font
        run: |
          mkdir -p Pack/font
          curl -L -o Pack/font/KosugiMaru-Regular.ttf https://github.com/google/fonts/raw/main/ofl/kosugimaru/KosugiMaru-Regular.ttf

      - name: Generate glyph PNGs
        run: |
          set -e
          export LANG=C.UTF-8
          IMG_SIZE=64
          RP_DIR=Pack
          FONT_FILE="$RP_DIR/font/KosugiMaru-Regular.ttf"
          mkdir -p "$RP_DIR/font"

          # Deno スクリプトの d8 文字列を継承
          D8='ÀÁÂÈÊËÍÓÔÕÚßãõğİıŒœŞşŴŵžȇ§© !"#$%&'\''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜø£Ø×ƒáíóúñÑªº¿®¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αβΓπΣσμτΦΘΩδ∞∅∈∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■'

          # -1 (D8 文字) と 0-255 (ASCII) を順に処理
          for i in $(seq -1 255); do
            if [ "$i" -lt 0 ]; then
              # D8 配列の文字
              INDEX=$((i + 1 + ${#D8})) # 文字列の最後に正しくマップ
              CHAR=$(echo -n "$D8" | cut -c$((i + 2)))
            else
              CHAR=$(printf "\\$(printf '%03o' "$i")") # ASCII を octal で渡す
            fi

            # 文字が空でなければ生成
            if [ -n "$CHAR" ]; then
              HEX=$(printf "%02x" $((i < 0 ? i + 256 : i))) # -1 は ff に
              convert -size "${IMG_SIZE}x${IMG_SIZE}" -background none \
                -fill white -font "$FONT_FILE" -pointsize "$IMG_SIZE" \
                -gravity northwest caption:"$CHAR" \
                "$RP_DIR/font/glyph_$HEX.png" || echo "Skipped invalid char: $CHAR"
            fi
          done

      - name: Commit generated Pack
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Pack
          git pull
          git diff-index --quiet HEAD || git commit -m "Auto-update glyph PNGs"
          git push
