name: Build Glyph Pack (sh + curl + ImageMagick)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y imagemagick curl

      - name: Setup Pack and font
        run: |
          mkdir -p Pack/font
          curl -L -o Pack/font/KosugiMaru-Regular.ttf https://github.com/google/fonts/raw/main/ofl/kosugimaru/KosugiMaru-Regular.ttf

      - name: Generate glyph PNGs
        run: |
          set -e
          export LANG=C.UTF-8
          IMG_SIZE=64
          RP_DIR=Pack
          FONT_FILE="$RP_DIR/font/KosugiMaru-Regular.ttf"
          mkdir -p "$RP_DIR/font"

          # Deno スクリプトの d8 文字列を継承
          D8='ÀÁÂÈÊËÍÓÔÕÚßãõğİıŒœŞşŴŵžȇ§© !"#$%&'\''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜø£Ø×ƒáíóúñÑªº¿®¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αβΓπΣσμτΦΘΩδ∞∅∈∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■ '

          # 生成リスト
          LIST=$(seq -1 255)
          
          for i in $LIST; do
            if [ "$i" -lt 0xd8 ] || [ "$i" -gt 0xf5 ]; then
              if [ "$i" -lt 0 ]; then
                CHAR=$(echo -n "$D8" | cut -c$((i + 2))) # cut は 1 始まり、-1 を補正
              else
                CHAR=$(printf "\\$(printf '%03o' "$i")") # ASCII 文字を安全に
              fi

              FILENAME="$RP_DIR/font/glyph_$(printf '%02x' $i).png"

              # 空文字の場合はスキップ
              if [ -n "$CHAR" ]; then
                convert -size "${IMG_SIZE}x${IMG_SIZE}" -background none \
                  -fill white -font "$FONT_FILE" -pointsize "$IMG_SIZE" \
                  -gravity northwest caption:"$CHAR" \
                  "$FILENAME" || echo "Skipped invalid char: $CHAR"
              fi
            fi
          done

      - name: Commit generated Pack
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Pack
          git diff-index --quiet HEAD || git commit -m "Auto-update glyph PNGs"
          git push
