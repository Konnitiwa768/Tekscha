name: Build Glyph Pack (sh + curl + ImageMagick)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 必要ツールをインストール
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y imagemagick curl

      # Pack ディレクトリ作成 & フォント取得
      - name: Setup Pack and font
        run: |
          mkdir -p Pack/font
          curl -L -o Pack/font/KosugiMaru-Regular.ttf https://github.com/google/fonts/raw/main/ofl/kosugimaru/KosugiMaru-Regular.ttf

      # glyph PNG を生成
      - name: Generate glyph PNGs
        run: |
          set -e
          IMG_SIZE=64
          RP_DIR=Pack
          FONT_FILE="$RP_DIR/font/KosugiMaru-Regular.ttf"
          mkdir -p "$RP_DIR/font"

          # ASCII + d8 (Unicode 特殊文字を含む)
          D8="ÀÁÂÈÊËÍÓÔÕÚßãõğİıŒœŞşŴŵžȇ§© !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_\`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜø£Ø×ƒáíóúñÑªº¿®¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αβΓπΣσμτΦΘΩδ∞∅∈∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■"

          for i in $(seq 0 255); do
            if [ "$i" -lt 216 ] || [ "$i" -gt 245 ]; then
              # ASCII または d8 の文字を選択
              if [ "$i" -lt 0 ]; then
                CHAR=$(echo "$D8" | cut -c$((i+1)))
              else
                # Unicode エスケープで安全に渡す
                CHAR=$(printf "\\u%04x" $i)
              fi

              convert -size "${IMG_SIZE}x${IMG_SIZE}" -background none \
                -fill white -font "$FONT_FILE" -pointsize "$IMG_SIZE" \
                -gravity northwest caption:"$CHAR" \
                "$RP_DIR/font/glyph_$(printf "%02x" $i).png"
            fi
          done

      # 生成結果をコミット
      - name: Commit generated Pack
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Pack
          git diff-index --quiet HEAD || git commit -m "Auto-update glyph PNGs"
          git push
