name: Generate Swords from Base (BE Resource Pack)

on:
  workflow_dispatch:
  push:
    branches:
      - main2

jobs:
  generate_swords:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: |
          sudo apt-get update -y
          sudo apt-get install -y imagemagick

      - name: Prepare output directory
        run: |
          mkdir -p Pack3/textures/items

      - name: Generate swords from sword.png
        run: |
          base="sword.png"
          outdir="Pack3/textures/items"

          if [ ! -f "$base" ]; then
            echo "Base sword.png not found"
            exit 1
          fi

          # ===== カラー定義 =====
          declare -A colors=(
            ["wood"]="#C49A6A"
            ["stone"]="#7D7D7D"
            ["copper"]="#BA1400"
            ["iron"]="#B8B8B8"
            ["gold"]="#FFD700"
            ["diamond"]="#8ECAFF"
            ["netherite"]="#6A2A6A"
          )

          # 幅と高さ取得
          w=$(identify -format "%w" "$base")
          h=$(identify -format "%h" "$base")

          # ===== 生成ループ =====
          for type in "${!colors[@]}"; do
            overlay="${colors[$type]}"
            out="$outdir/${type}_sword.png"

            echo "Generating $out ..."

            # 透明保護付き Overlay
            convert "$base" \
              \( -size ${w}x${h} xc:"$overlay" \) \
              -compose Overlay -composite \
              \( "$base" -alpha extract \) -compose CopyOpacity -composite \
              "$out"
          done

      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Pack3/
          git pull
          git commit -m "Generate swords from base sword.png" || echo "No changes to commit"
          git push
